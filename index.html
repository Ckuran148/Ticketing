<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wendy's IT Technician Command Center (Cloud)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --wendys-red: #e21d38;
            --wendys-blue: #0072ce;
            --wendys-yellow: #ffc72c;
        }
        .bg-wendys-red { background-color: var(--wendys-red); }
        .text-wendys-red { color: var(--wendys-red); }
        .border-wendys-red { border-color: var(--wendys-red); }
        .text-wendys-blue { color: var(--wendys-blue); }
        .bg-wendys-blue { background-color: var(--wendys-blue); }
        
        body { background-color: #f3f4f6; }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .btn-primary {
            background-color: var(--wendys-red);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover { opacity: 0.9; }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            border-bottom-color: var(--wendys-red);
            color: var(--wendys-red);
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d1d1; border-radius: 10px; }
        
        /* Status Badge Colors */
        .status-badge-closed { background-color: #def7ec; color: #03543f; }
        .status-badge-pending { background-color: #fdf2f2; color: #9b1c1c; }
        
        /* Dynamic Turn Colors */
        .turn-tech { background-color: #ebf5ff; color: #1e429f; }
        .turn-site { background-color: #fef3c7; color: #92400e; }
        .turn-vendor { background-color: #f3e8ff; color: #6b21a8; }
        .turn-mgmt { background-color: #e1effe; color: #03543f; }
        .turn-other { background-color: #f3f4f6; color: #374151; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .pulse-pending {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: rgba(226, 29, 56, 0.2); }
            50% { border-color: rgba(226, 29, 56, 0.6); }
            100% { border-color: rgba(226, 29, 56, 0.2); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loader" class="loading-overlay">
        <div class="text-wendys-red font-bold text-xl animate-pulse mb-2">Syncing Cloud Center...</div>
        <div id="loader-error" class="text-xs text-gray-500 max-w-xs text-center px-4 italic">Connecting to Wendy's Team Database</div>
        <div id="auth-retry-btn" class="hidden mt-4">
            <button onclick="location.reload()" class="bg-gray-800 text-white px-4 py-2 rounded text-xs">Retry Connection</button>
        </div>
    </div>

    <header class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-wendys-red rounded-full flex items-center justify-center text-white font-bold text-2xl">W</div>
            <div>
                <h1 class="text-2xl font-bold text-gray-800">IT Technician Command Center</h1>
                <p class="text-xs text-gray-500">Shared Cloud Session: <span id="display-app-id" class="font-bold text-wendys-blue">...</span></p>
            </div>
        </div>
        <div id="current-date" class="text-gray-500 font-medium italic text-right text-sm"></div>
    </header>

    <nav class="max-w-7xl mx-auto flex gap-4 mb-6 border-b border-gray-200 overflow-x-auto">
        <button onclick="switchTab('log')" id="tab-log" class="tab-btn active">Daily Work Log</button>
        <button onclick="switchTab('manager')" id="tab-manager" class="tab-btn">Ticket Manager</button>
        <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn">Control Panel</button>
    </nav>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Tab Content: Daily Log -->
        <div id="content-log" class="lg:col-span-3 space-y-6">
            <section class="card border-t-4 border-wendys-red" id="log-form-section">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">üìù <span id="form-title">Log New Work / Activity</span></h2>
                <input type="hidden" id="editing-id" value="">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700">Site # / Name <span id="site-req-star" class="text-red-500">*</span></label>
                        <input type="text" id="site-id" class="input-field" placeholder="e.g. Site #4502">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700">Ticket # (Optional)</label>
                        <input type="text" id="ticket-number" class="input-field" placeholder="e.g. INC10045">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700">Activity Type</label>
                        <select id="ticket-type" class="input-field" onchange="handleActivityTypeChange()">
                            <optgroup label="Tickets" id="group-tickets">
                                <option value="Aloha POS">Aloha POS</option>
                                <option value="KDS / Controller">KDS / Controller</option>
                                <option value="Network">Network / Router</option>
                                <option value="Printer">Printer Issue</option>
                                <option value="Email / Login">Email / Login Issue</option>
                            </optgroup>
                            <optgroup label="Non-Ticket / Admin" id="group-admin">
                                <option value="Email Correspondence">Email Correspondence</option>
                                <option value="Daily Recap">Daily Recap / Reporting</option>
                                <option value="Phone Troubleshooting">Phone Troubleshooting</option>
                                <option value="Project Work">Project Work</option>
                                <option value="Meeting">Meeting / Internal</option>
                                <option value="Other">Other (Custom)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Custom Activity Input -->
                <div id="custom-activity-container" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700">Specify Other Activity <span class="text-red-500">*</span></label>
                    <input type="text" id="custom-activity-type" class="input-field" placeholder="e.g. Server Maintenance">
                </div>

                <textarea id="work-desc" class="input-field h-24" placeholder="Briefly describe what you did..."></textarea>
                <div class="flex items-center justify-between mb-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="ticket-closed" class="w-5 h-5 accent-red-600">
                        <span class="text-sm font-semibold text-gray-700">Task Completed / Ticket Closed</span>
                    </label>
                    <button id="cancel-edit" onclick="resetForm()" class="hidden text-sm text-gray-500 hover:underline">Cancel Edit</button>
                </div>
                <button id="submit-btn" onclick="logWork()" class="btn-primary w-full md:w-auto">Add to Daily Log</button>
            </section>

            <!-- Global Pending Tasks (Persistent) -->
            <section class="card border-l-4 border-yellow-500 bg-yellow-50/30">
                <h3 class="text-sm font-bold text-yellow-700 uppercase mb-3 flex items-center gap-2">
                    ‚ö†Ô∏è Unresolved Task Queue
                    <span id="pending-count-badge" class="bg-yellow-200 text-yellow-800 text-[10px] px-2 py-0.5 rounded-full">0</span>
                </h3>
                <div id="global-pending-list" class="space-y-2">
                    <!-- Global pending items appear here -->
                </div>
            </section>

            <section class="card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Date Log</h2>
                        <p class="text-xs text-gray-500">Viewing logs for specific date selected below.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-gray-400">VIEW DATE:</label>
                        <input type="date" id="log-view-date" onchange="renderLogs()" class="border rounded p-1 text-sm outline-none focus:border-wendys-red">
                        <button onclick="clearLogs()" class="text-xs text-red-400 hover:text-red-600 ml-2">Clear All</button>
                    </div>
                </div>
                <div id="activity-list" class="space-y-3"></div>
            </section>
        </div>

        <!-- Tab Content: Ticket Manager (Imported) -->
        <div id="content-manager" class="lg:col-span-3 space-y-6 hidden">
            <section class="card border-t-4 border-wendys-blue">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold">Imported Ticket Tracker</h2>
                        <p class="text-sm text-gray-500">Synced across all technicians.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <label class="bg-gray-100 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-200 transition text-xs font-semibold">
                            üìÅ Import Tickets CSV
                            <input type="file" id="csv-import" class="hidden" accept=".csv" onchange="importTickets(event)">
                        </label>
                        <button onclick="exportTicketsCSV()" class="bg-gray-800 text-white px-3 py-2 rounded-lg text-xs font-semibold hover:bg-black transition">
                            üíæ Export CSV
                        </button>
                        <button onclick="clearImportedTickets()" class="text-xs text-red-500 hover:underline">Clear List</button>
                    </div>
                </div>

                <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="ticket-search" onkeyup="filterImportedTickets()" placeholder="Search Site or Ticket #..." class="input-field mb-0 md:col-span-2">
                    <select id="sort-order" onchange="filterImportedTickets()" class="input-field mb-0">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                    <select id="filter-status" onchange="filterImportedTickets()" class="input-field mb-0">
                        <option value="all">All Status</option>
                        <option value="pending">Pending Only</option>
                        <option value="closed">Closed Only</option>
                    </select>
                </div>

                <div id="imported-ticket-list" class="space-y-4"></div>
            </section>
        </div>

        <!-- Tab Content: Control Panel -->
        <div id="content-settings" class="lg:col-span-3 space-y-6 hidden">
            <section class="card border-t-4 border-gray-600">
                <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Control Panel</h2>
                
                <!-- Site Directory -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">1. Site & Email Directory</h3>
                    <p class="text-sm text-gray-500 mb-2">Manually upload `Emails DM Sites CSV.csv` or try loading from server.</p>
                    <div class="flex items-center gap-4">
                        <label class="bg-wendys-blue text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700 transition text-sm font-semibold">
                            üìÅ Upload Local CSV
                            <input type="file" id="site-csv-import" class="hidden" accept=".csv" onchange="importSiteDirectory(event)">
                        </label>
                        <button onclick="loadServerDirectory()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-900 transition text-sm font-semibold">
                            ‚òÅÔ∏è Load Default CSV (Server)
                        </button>
                        <span id="site-count-badge" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">0 Sites Loaded</span>
                    </div>
                </div>

                <!-- Email Config -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">2. Default Email Configuration</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">DEFAULT CC (Comma separated):</label>
                            <input type="text" id="default-cc" class="input-field" value="mbisbee@wenspok.com" placeholder="email@example.com">
                        </div>
                    </div>
                </div>

                <!-- Vendor Config -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">3. Vendor Directory</h3>
                    <p class="text-xs text-gray-500 mb-2">Add vendors and their departments. Set a default email for each vendor.</p>
                    <div class="flex gap-2 mb-2">
                        <button onclick="openVendorEditor()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold text-sm">‚ûï Add New Vendor</button>
                    </div>
                    <div id="vendor-list" class="space-y-2 border p-2 rounded bg-gray-50 max-h-60 overflow-y-auto">
                        <!-- Vendors rendered here -->
                    </div>
                </div>

                <!-- Template Editor -->
                <div class="mb-8">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">4. Email Templates</h3>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 text-xs text-yellow-800">
                        <strong>Variables:</strong> 
                        <code>{ticket}</code> = Ticket #, 
                        <code>{site}</code> = Site Name, 
                        <code>{issue}</code> = Short Description, 
                        <code>{created}</code> = Date Opened, 
                        <code>{lifespan}</code> = Days Open.
                    </div>
                    <div class="flex gap-2 mb-4">
                        <button onclick="openTemplateEditor()" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold w-full md:w-auto">‚ûï Create New Template</button>
                    </div>
                    <div id="template-list" class="space-y-2">
                        <!-- Templates rendered here -->
                    </div>
                </div>

                <!-- Quick Links Editor -->
                <div>
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">5. Quick Links</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-link-name" class="input-field mb-0 w-1/3" placeholder="Link Name">
                        <input type="text" id="new-link-url" class="input-field mb-0 w-2/3" placeholder="URL (https://...)">
                        <button onclick="addQuickLink()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm">Add</button>
                    </div>
                    <div id="quick-links-editor" class="space-y-2 border p-2 rounded bg-gray-50 max-h-60 overflow-y-auto">
                        <!-- Quick Link Editors -->
                    </div>
                    <div class="mt-6 pt-4 border-t">
                        <button onclick="saveSettings()" class="btn-primary w-full md:w-auto">üíæ Save All Settings</button>
                    </div>
                </div>

            </section>
        </div>

        <!-- Right Column: Shared Tools -->
        <div class="space-y-6">
            <section class="card bg-gray-900 text-white">
                <h2 class="text-xl font-bold mb-2 text-wendys-yellow">Daily Recap</h2>
                <p class="text-[10px] text-gray-400 mb-3 italic">Generates summary for the date selected in the activity log.</p>
                <button onclick="generateRecap()" class="w-full bg-wendys-blue hover:bg-blue-600 text-white py-3 rounded-lg font-bold transition">üìã Generate Email</button>
            </section>

            <!-- Status Quick Stats -->
            <section class="card border-t-4 border-wendys-blue">
                <h2 class="text-lg font-bold mb-3 border-b pb-2 text-gray-700">Team Analytics</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-2 rounded text-center">
                        <span class="block text-[10px] uppercase font-bold text-blue-400">Open</span>
                        <span id="stat-total-open" class="text-xl font-bold text-blue-700">0</span>
                    </div>
                    <div class="bg-green-50 p-2 rounded text-center">
                        <span class="block text-[10px] uppercase font-bold text-green-400">Closed</span>
                        <span id="stat-total-closed" class="text-xl font-bold text-green-700">0</span>
                    </div>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Closure Rate:</span>
                        <span id="stat-closure-percent" class="font-bold text-gray-800">0%</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-500">Avg Close Time:</span>
                        <span id="stat-avg-time" class="font-bold text-gray-800">N/A</span>
                    </div>
                    <hr>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">Wait for Tech:</span>
                        <span id="stat-tech-turn" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">Wait for Site:</span>
                        <span id="stat-site-turn" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between text-xs">
                        <span class="text-gray-400">Wait for Others:</span>
                        <span id="stat-other-turn" class="font-bold">0</span>
                    </div>
                </div>
                <div class="pt-2 border-t mt-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Current Open Total:</span>
                        <span id="stat-total-all" class="font-bold">0</span>
                    </div>
                </div>
            </section>

            <!-- Quick Links -->
            <section class="card">
                <h2 class="text-lg font-bold mb-3 border-b pb-2 text-gray-700">Quick Links</h2>
                <div id="quick-links-list" class="space-y-2 text-sm flex flex-col">
                    <!-- Links rendered here -->
                    <p class="text-gray-400 italic text-xs">No links added.</p>
                </div>
            </section>

            <section class="card border-l-4 border-wendys-red">
                <h2 class="text-lg font-bold mb-3 text-gray-700">Email Templates</h2>
                <div class="space-y-2">
                    <button onclick="copyTemplate('welcome')" class="w-full text-left text-xs bg-white border p-2 rounded hover:bg-gray-50">Ticket Received</button>
                    <button onclick="copyTemplate('followup')" class="w-full text-left text-xs bg-white border p-2 rounded hover:bg-gray-50">Contact Follow-up</button>
                    <button onclick="copyTemplate('closed')" class="w-full text-left text-xs bg-white border p-2 rounded hover:bg-gray-50">Resolution Confirmation</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Vendor Editor Modal -->
    <div id="vendor-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Edit Vendor Details</h3>
                <button onclick="closeVendorEditor()" class="text-gray-500 hover:text-red-500 font-bold">&times;</button>
            </div>
            <input type="hidden" id="edit-vendor-id">
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">VENDOR NAME:</label>
                <input type="text" id="edit-vendor-name" class="input-field mb-0">
            </div>

            <h4 class="text-sm font-bold text-gray-700 mb-2 border-b">Departments / Emails</h4>
            <div id="edit-vendor-depts" class="space-y-2 mb-4">
                <!-- Dept rows injected here -->
            </div>

            <div class="bg-gray-50 p-2 rounded border mb-4">
                <h5 class="text-xs font-bold text-gray-500 mb-2">Add New Department</h5>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="text" id="new-dept-name" class="input-field mb-0 text-xs" placeholder="Dept Name (e.g. Billing)">
                    <input type="text" id="new-dept-email" class="input-field mb-0 text-xs" placeholder="Email Address">
                </div>
                <button onclick="addVendorDeptRow()" class="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold w-full">Add Department</button>
            </div>

            <div class="flex gap-3">
                <button onclick="saveVendorChanges()" class="flex-1 btn-primary">Save Vendor</button>
                <button onclick="closeVendorEditor()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Ticket Notes -->
    <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Cloud Update</h3>
            <input type="hidden" id="note-ticket-id">
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">WHOSE TURN?</label>
                    <input list="turn-options" id="note-turn" class="input-field mb-0" placeholder="Type or select...">
                    <datalist id="turn-options">
                        <option value="Technician">
                        <option value="Site">
                        <option value="NCR/ Accenture">
                        <option value="Viking Cloud">
                        <option value="Mood">
                        <option value="DM">
                        <option value="Jolt">
                        <option value="Other">
                    </datalist>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">SITE RESPONDED?</label>
                    <select id="note-responded" class="input-field mb-0">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">VENDOR:</label>
                <input list="turn-options" id="note-vendor" class="input-field mb-0" placeholder="Specify Vendor...">
            </div>

            <label class="block text-xs font-bold text-gray-500 mb-1">TICKET NOTES:</label>
            <textarea id="note-text" class="input-field h-32" placeholder="Notes sync automatically..."></textarea>
            
            <div class="flex gap-3">
                <button onclick="saveNote()" class="flex-1 btn-primary">Sync to Cloud</button>
                <button onclick="closeNotes()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Email Template Selection Modal -->
    <div id="email-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-1">Compose Email</h3>
            <div id="email-mode-display" class="mb-4 font-bold uppercase text-xs tracking-wide"></div>
            
            <div id="email-vendor-dept-container" class="hidden mb-4 bg-purple-50 p-2 rounded border border-purple-200">
                <label class="block text-xs font-bold text-purple-700 mb-1">Select Department:</label>
                <select id="email-vendor-dept" class="w-full p-2 border rounded text-sm"></select>
            </div>

            <p class="text-xs text-gray-500 mb-4">Select a template to launch your mail client with pre-filled details.</p>
            <input type="hidden" id="email-ticket-id">
            <input type="hidden" id="email-mode-val">
            <div id="email-template-options" class="space-y-2 mb-4">
                <!-- Buttons injected here -->
            </div>
            <button onclick="closeEmailModal()" class="btn-secondary w-full">Cancel</button>
        </div>
    </div>

    <!-- Template Editor Modal -->
    <div id="template-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold">Edit Email Template</h3>
                <button onclick="closeTemplateEditor()" class="text-gray-500 hover:text-red-500 font-bold">&times;</button>
            </div>
            <input type="hidden" id="edit-tpl-id">
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">TEMPLATE NAME:</label>
                <input type="text" id="edit-tpl-name" class="input-field mb-0" placeholder="e.g. Follow Up">
            </div>

            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">EMAIL SUBJECT:</label>
                <input type="text" id="edit-tpl-subject" class="input-field mb-0 font-mono text-sm" placeholder="NCR Ticket {ticket}...">
            </div>

            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1">EMAIL BODY:</label>
                <textarea id="edit-tpl-body" class="input-field h-40 font-mono text-sm mb-0"></textarea>
            </div>

            <div class="flex gap-4 mb-6">
                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 p-2 rounded border w-1/2">
                    <input type="checkbox" id="edit-tpl-increment">
                    <span class="text-xs font-bold text-gray-700">Auto-Increment Attempt?</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 p-2 rounded border w-1/2">
                    <input type="checkbox" id="edit-tpl-ccdm">
                    <span class="text-xs font-bold text-gray-700">Include DM in CC?</span>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="saveTemplateChanges()" class="flex-1 btn-primary">Save Template</button>
                <button onclick="closeTemplateEditor()" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Recap Modal -->
    <div id="recap-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Daily IT Summary</h3>
                <button onclick="closeRecap()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="recap-content" class="bg-gray-50 p-4 border rounded-lg font-mono text-sm whitespace-pre-wrap max-h-96 overflow-y-auto mb-4"></div>
            <button onclick="copyRecapToClipboard()" class="w-full btn-primary">Copy to Clipboard</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl translate-y-20 transition-transform duration-300 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const myFirebaseConfig = {
          apiKey: "AIzaSyCRGIPlCxYxyllCnpseWDMVzRR56WQoV-k",
          authDomain: "chore-quest-8eda3.firebaseapp.com",
          projectId: "chore-quest-8eda3",
          storageBucket: "chore-quest-8eda3.firebasestorage.app",
          messagingSenderId: "300249788118",
          appId: "1:300249788118:web:5c48010bd7107383b5e377",
          measurementId: "G-001RJV5E4X"
        };

        let finalConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            finalConfig = JSON.parse(__firebase_config);
        } else {
            finalConfig = myFirebaseConfig;
        }

        const app = initializeApp(finalConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const teamAppId = 'wendys-it-team-shared-v1';
        document.getElementById('display-app-id').innerText = teamAppId;

        const logsRef = collection(db, 'artifacts', teamAppId, 'public', 'data', 'workLogs');
        const ticketsRef = collection(db, 'artifacts', teamAppId, 'public', 'data', 'importedTickets');
        const settingsRef = collection(db, 'artifacts', teamAppId, 'public', 'data', 'settings');

        let workLogs = [];
        let importedTickets = [];
        let siteDirectory = {}; // Site Number -> { storeEmail, dmEmail }
        
        // Vendor Structure: [ { id: 'v1', name: 'NCR', departments: [ { name: 'Support', email: 'x@x.com', default: true } ] } ]
        let vendorDirectory = []; 
        let quickLinks = []; // { name: '', url: '' }

        let emailTemplates = [
            { id: 'tpl_welcome', name: 'Ticket Received', increment: false, ccDM: true, subject: 'NCR Ticket {ticket} - {issue}', body: 'Team,\n\nI have received your request regarding ticket {ticket}. I am checking the logs for your site ({site}) and will call shortly.\n\nThanks,\nWendy\'s IT Technician' },
            { id: 'tpl_followup', name: 'Follow Up', increment: true, ccDM: true, subject: 'NCR Ticket {ticket} - Follow Up', body: 'Team,\n\nI attempted to call site {site} to troubleshoot ticket {ticket} but was unable to reach anyone. Please let me know a good time to call back.\n\nThanks,\nWendy\'s IT Technician' },
            { id: 'tpl_closed', name: 'Ticket Closed', increment: false, ccDM: true, subject: 'NCR Ticket {ticket} - Resolved', body: 'Team,\n\nTicket {ticket} for site {site} has been resolved. Please test and let me know if you need anything else.\n\nThanks,\nWendy\'s IT Technician' }
        ];
        let defaultCC = 'mbisbee@wenspok.com';
        let user = null;
        let currentEditingVendor = null;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
                showLoaderError("Auth Failed: Enable 'Anonymous' sign-in in Firebase Console.");
            }
        };

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('log-view-date').value = today;
            const dateDisplay = document.getElementById('current-date');
            dateDisplay.innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            initAuth();
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                setupListeners();
                document.getElementById('loader').classList.add('hidden');
            }
        });

        const setupListeners = () => {
            if (!user) return;

            onSnapshot(logsRef, (snapshot) => {
                workLogs = snapshot.docs.map(d => ({ ...d.data(), fireId: d.id }))
                    .sort((a, b) => b.id - a.id);
                renderLogs();
            }, (err) => handleError(err));

            onSnapshot(ticketsRef, (snapshot) => {
                importedTickets = snapshot.docs.map(d => ({ ...d.data(), fireId: d.id }));
                renderImportedTickets();
            }, (err) => handleError(err));

            onSnapshot(settingsRef, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (doc.id === 'siteDirectory') {
                        siteDirectory = data.sites || {};
                        updateSiteCount();
                    } else if (doc.id === 'config') {
                        if (data.defaultCC) defaultCC = data.defaultCC;
                        if (data.templates) emailTemplates = data.templates;
                        if (data.vendorDirectory) {
                            vendorDirectory = Array.isArray(data.vendorDirectory) ? data.vendorDirectory : [];
                        }
                        if (data.quickLinks) quickLinks = Array.isArray(data.quickLinks) ? data.quickLinks : [];
                        
                        renderTemplates();
                        renderVendors();
                        renderQuickLinks();
                        renderQuickLinkSettings();
                        document.getElementById('default-cc').value = defaultCC;
                    }
                });
            });
        };

        function handleError(err) {
            console.error("Sync error:", err);
            if (err.code === 'permission-denied') {
                showLoaderError("Database Denied: Update Firestore Rules.");
            }
        }

        function showLoaderError(msg) {
            const errEl = document.getElementById('loader-error');
            errEl.innerHTML = `<span class="text-red-500 font-bold">${msg}</span>`;
            document.getElementById('auth-retry-btn').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
        }

        // --- Settings / Control Panel Logic ---
        function updateSiteCount() {
            const count = Object.keys(siteDirectory).length;
            document.getElementById('site-count-badge').innerText = `${count} Sites Loaded`;
        }

        window.loadServerDirectory = async () => {
            try {
                const response = await fetch('./Emails DM Sites CSV.csv');
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                processDirectoryCSV(text);
            } catch (err) {
                console.error(err);
                showToast("Server Load Failed: Check file location.");
            }
        };

        window.importSiteDirectory = async (event) => {
            if (!user) return;
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                processDirectoryCSV(e.target.result);
            };
            reader.readAsText(file);
        };

        async function processDirectoryCSV(text) {
            const rows = text.split(/\r?\n/).slice(1); // Skip header
            const newDirectory = {};
            
            rows.filter(r => r.trim()).forEach(row => {
                // CSV: Site,Store,Market,District,Store_Email,DM_Email,DAO_Email
                const cols = row.split(',').map(c => c.trim());
                if (cols[0]) {
                    newDirectory[cols[0]] = {
                        storeEmail: cols[4] || '',
                        dmEmail: cols[5] || ''
                    };
                }
            });

            await setDoc(doc(settingsRef, 'siteDirectory'), { sites: newDirectory });
            showToast(`Directory Updated: ${Object.keys(newDirectory).length} sites.`);
        }

        window.renderTemplates = () => {
            const list = document.getElementById('template-list');
            list.innerHTML = emailTemplates.map((tpl, index) => `
                <div class="border p-3 rounded bg-white hover:shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-700">${tpl.name}</div>
                        <div class="text-[10px] text-gray-400 font-mono">${tpl.subject.substring(0, 30)}...</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTemplateEditor(${index})" class="text-blue-500 text-xs font-bold hover:underline bg-blue-50 px-2 py-1 rounded">Edit</button>
                        <button onclick="deleteTemplate(${index})" class="text-red-500 text-xs hover:underline bg-red-50 px-2 py-1 rounded">Delete</button>
                    </div>
                </div>
            `).join('');
        };

        // --- Vendor Directory Logic (Advanced) ---
        window.renderVendors = () => {
            const list = document.getElementById('vendor-list');
            if(vendorDirectory.length === 0) {
                list.innerHTML = `<p class="text-gray-400 text-xs italic text-center">No vendors defined.</p>`;
                return;
            }
            list.innerHTML = vendorDirectory.map((v, idx) => {
                const deptCount = v.departments ? v.departments.length : 0;
                const hasEmails = deptCount > 0;
                const badge = hasEmails 
                    ? `<span class="bg-gray-100 text-gray-600 text-[10px] px-2 rounded-full">${deptCount} Depts</span>` 
                    : `<span class="bg-red-100 text-red-600 text-[10px] px-2 rounded-full font-bold">No Emails</span>`;
                
                return `
                <div class="flex justify-between items-center text-xs p-2 border-b last:border-0 bg-white">
                    <span class="font-bold text-gray-800">${v.name} ${badge}</span>
                    <div class="flex gap-2">
                        <button onclick="openVendorEditor(${idx})" class="text-blue-600 hover:underline font-bold">Edit</button>
                        <button onclick="deleteVendor(${idx})" class="text-red-500 hover:underline">&times;</button>
                    </div>
                </div>
            `}).join('');
        };

        window.openVendorEditor = (idx = null) => {
            const isNew = idx === null;
            const vendor = isNew 
                ? { id: 'v_' + Date.now(), name: '', departments: [] } 
                : JSON.parse(JSON.stringify(vendorDirectory[idx])); // Deep copy
            
            currentEditingVendor = { ...vendor, index: idx };
            
            document.getElementById('edit-vendor-id').value = isNew ? 'new' : idx;
            document.getElementById('edit-vendor-name').value = vendor.name;
            renderVendorDepts();
            
            document.getElementById('vendor-editor-modal').classList.remove('hidden');
        };

        window.closeVendorEditor = () => {
            document.getElementById('vendor-editor-modal').classList.add('hidden');
            currentEditingVendor = null;
        }

        window.renderVendorDepts = () => {
            const list = document.getElementById('edit-vendor-depts');
            const depts = currentEditingVendor.departments;
            if(depts.length === 0) {
                list.innerHTML = `<p class="text-xs text-red-400 italic">No departments added yet.</p>`;
                return;
            }
            list.innerHTML = depts.map((d, i) => `
                <div class="flex items-center gap-2 text-xs border p-1 rounded bg-gray-50">
                    <div class="flex-1 font-bold">${d.name} <span class="font-normal text-gray-500"><${d.email}></span></div>
                    <label class="flex items-center gap-1 cursor-pointer">
                        <input type="radio" name="dept_default" ${d.default ? 'checked' : ''} onchange="setVendorDefault(${i})">
                        <span class="text-[10px]">Default</span>
                    </label>
                    <button onclick="removeVendorDept(${i})" class="text-red-500 font-bold px-2">&times;</button>
                </div>
            `).join('');
        };

        window.addVendorDeptRow = () => {
            const name = document.getElementById('new-dept-name').value.trim();
            const email = document.getElementById('new-dept-email').value.trim();
            if(!name || !email) return alert("Name and Email required");
            
            const isFirst = currentEditingVendor.departments.length === 0;
            currentEditingVendor.departments.push({ name, email, default: isFirst });
            
            document.getElementById('new-dept-name').value = '';
            document.getElementById('new-dept-email').value = '';
            renderVendorDepts();
        };

        window.removeVendorDept = (i) => {
            currentEditingVendor.departments.splice(i, 1);
            // If we deleted the default, set first as default
            if(currentEditingVendor.departments.length > 0 && !currentEditingVendor.departments.some(d => d.default)) {
                currentEditingVendor.departments[0].default = true;
            }
            renderVendorDepts();
        };

        window.setVendorDefault = (i) => {
            currentEditingVendor.departments.forEach((d, idx) => d.default = (idx === i));
            renderVendorDepts();
        };

        window.saveVendorChanges = async () => {
            const name = document.getElementById('edit-vendor-name').value.trim();
            if(!name) return alert("Vendor Name required");
            
            currentEditingVendor.name = name;
            
            // Clean up temporary index
            const idx = currentEditingVendor.index;
            delete currentEditingVendor.index;

            if (idx === null || idx === 'new') {
                vendorDirectory.push(currentEditingVendor);
            } else {
                vendorDirectory[idx] = currentEditingVendor;
            }
            
            // Sort by name
            vendorDirectory.sort((a,b) => a.name.localeCompare(b.name));
            
            await saveSettings(); // Persist to cloud
            closeVendorEditor();
            renderVendors();
        };

        window.deleteVendor = async (idx) => {
            if(confirm(`Delete vendor?`)) {
                vendorDirectory.splice(idx, 1);
                await saveSettings();
                renderVendors();
            }
        };

        // --- Quick Links Logic ---
        window.renderQuickLinks = () => {
            const list = document.getElementById('quick-links-list');
            if (quickLinks.length === 0) {
                list.innerHTML = `<p class="text-gray-400 italic text-xs">No links added.</p>`;
                return;
            }
            list.innerHTML = quickLinks.map(link => `
                <a href="${link.url}" target="_blank" class="block py-1 px-2 hover:bg-gray-100 rounded text-blue-600 hover:underline truncate">
                    üîó ${link.name}
                </a>
            `).join('');
        };

        window.renderQuickLinkSettings = () => {
            const list = document.getElementById('quick-links-editor');
            if (quickLinks.length === 0) {
                list.innerHTML = `<p class="text-gray-400 italic text-xs text-center">No links to edit.</p>`;
                return;
            }
            list.innerHTML = quickLinks.map((link, idx) => `
                <div class="flex gap-2 items-center mb-1 pb-1 border-b last:border-0">
                    <input type="text" value="${link.name}" onchange="updateQuickLink(${idx}, 'name', this.value)" class="input-field mb-0 text-xs w-1/3">
                    <input type="text" value="${link.url}" onchange="updateQuickLink(${idx}, 'url', this.value)" class="input-field mb-0 text-xs w-1/2">
                    <button onclick="deleteQuickLink(${idx})" class="text-red-500 font-bold px-2">&times;</button>
                </div>
            `).join('');
        };

        window.addQuickLink = () => {
            const name = document.getElementById('new-link-name').value.trim();
            const url = document.getElementById('new-link-url').value.trim();
            if (!name || !url) return alert("Name and URL required");
            
            quickLinks.push({ name, url });
            document.getElementById('new-link-name').value = '';
            document.getElementById('new-link-url').value = '';
            
            // Re-render local state immediately
            renderQuickLinks();
            renderQuickLinkSettings();
        };

        window.updateQuickLink = (idx, field, value) => {
            quickLinks[idx][field] = value;
            renderQuickLinks(); // update sidebar live
        };

        window.deleteQuickLink = (idx) => {
            if(confirm("Delete link?")) {
                quickLinks.splice(idx, 1);
                renderQuickLinks();
                renderQuickLinkSettings();
            }
        };

        // --- Template Editor Logic ---
        window.openTemplateEditor = (index = null) => {
            const isNew = index === null;
            const tpl = isNew ? { id: 'tpl_' + Date.now(), name: '', subject: 'NCR Ticket {ticket} - {issue}', body: 'Body...', increment: false, ccDM: true } : emailTemplates[index];
            
            document.getElementById('edit-tpl-id').value = isNew ? 'new' : index;
            document.getElementById('edit-tpl-name').value = tpl.name;
            document.getElementById('edit-tpl-subject').value = tpl.subject;
            document.getElementById('edit-tpl-body').value = tpl.body;
            document.getElementById('edit-tpl-increment').checked = tpl.increment;
            document.getElementById('edit-tpl-ccdm').checked = tpl.ccDM !== false;

            document.getElementById('template-editor-modal').classList.remove('hidden');
        };

        window.closeTemplateEditor = () => document.getElementById('template-editor-modal').classList.add('hidden');

        window.saveTemplateChanges = () => {
            const index = document.getElementById('edit-tpl-id').value;
            const newTpl = {
                id: index === 'new' ? 'tpl_' + Date.now() : emailTemplates[index].id,
                name: document.getElementById('edit-tpl-name').value,
                subject: document.getElementById('edit-tpl-subject').value,
                body: document.getElementById('edit-tpl-body').value,
                increment: document.getElementById('edit-tpl-increment').checked,
                ccDM: document.getElementById('edit-tpl-ccdm').checked
            };

            if (index === 'new') {
                emailTemplates.push(newTpl);
            } else {
                emailTemplates[index] = newTpl;
            }
            
            renderTemplates();
            closeTemplateEditor();
        };

        window.addTemplate = () => openTemplateEditor(); 

        window.deleteTemplate = (idx) => {
            if(confirm('Delete template?')) {
                emailTemplates.splice(idx, 1);
                renderTemplates();
            }
        };

        window.saveSettings = async () => {
            if (!user) return;
            defaultCC = document.getElementById('default-cc').value;
            await setDoc(doc(settingsRef, 'config'), {
                defaultCC: defaultCC,
                templates: emailTemplates,
                vendorDirectory: vendorDirectory,
                quickLinks: quickLinks
            });
            showToast("Configuration Saved!");
        };

        // --- Email Logic ---
        window.openEmailModal = (ticketId, mode) => {
            document.getElementById('email-ticket-id').value = ticketId;
            document.getElementById('email-mode-val').value = mode;
            const modeDisplay = document.getElementById('email-mode-display');
            const deptContainer = document.getElementById('email-vendor-dept-container');
            const deptSelect = document.getElementById('email-vendor-dept');
            
            if(mode === 'vendor') {
                modeDisplay.innerText = "Drafting Email for VENDOR";
                modeDisplay.className = "mb-2 font-bold uppercase text-xs tracking-wide text-purple-600";
                
                const ticket = importedTickets.find(t => t.id === ticketId);
                const vendorData = vendorDirectory.find(v => v.name === ticket.vendor);
                
                if (vendorData && vendorData.departments && vendorData.departments.length > 0) {
                    deptContainer.classList.remove('hidden');
                    deptSelect.innerHTML = vendorData.departments.map(d => 
                        `<option value="${d.email}" ${d.default ? 'selected' : ''}>${d.name} (${d.email})</option>`
                    ).join('');
                } else {
                    deptContainer.classList.add('hidden');
                }

            } else {
                modeDisplay.innerText = "Drafting Email for SITE";
                modeDisplay.className = "mb-4 font-bold uppercase text-xs tracking-wide text-blue-600";
                deptContainer.classList.add('hidden');
            }

            const container = document.getElementById('email-template-options');
            container.innerHTML = emailTemplates.map(tpl => `
                <button onclick="launchEmail('${tpl.id}')" class="w-full text-left p-3 border rounded hover:bg-gray-100 flex justify-between items-center group">
                    <div>
                        <span class="font-bold text-gray-700 block">${tpl.name}</span>
                        <div class="flex gap-1 mt-1">
                            ${tpl.increment ? '<span class="text-[10px] text-green-600 bg-green-50 px-1 rounded border border-green-100">+ Attempts</span>' : ''}
                            ${tpl.ccDM !== false ? '<span class="text-[10px] text-purple-600 bg-purple-50 px-1 rounded border border-purple-100">+ CC DM</span>' : ''}
                        </div>
                    </div>
                    <span class="text-xs text-blue-500 group-hover:underline">Select &rarr;</span>
                </button>
            `).join('');
            document.getElementById('email-modal').classList.remove('hidden');
        };

        window.closeEmailModal = () => document.getElementById('email-modal').classList.add('hidden');

        window.launchEmail = (tplId) => {
            const ticketId = document.getElementById('email-ticket-id').value;
            const mode = document.getElementById('email-mode-val').value;
            const ticket = importedTickets.find(t => t.id === ticketId);
            const tpl = emailTemplates.find(t => t.id === tplId);
            
            if (!ticket || !tpl) return;

            if (tpl.increment) {
                changeAttempt(ticket.id, 1);
            }

            // --- Vendor Email Count Update ---
            if (mode === 'vendor') {
                incrementVendorCount(ticket.id);
            }

            // Site Lookup
            const siteInfo = siteDirectory[ticket.site] || { storeEmail: '', dmEmail: '' };
            let to = '';
            let ccList = defaultCC.split(',').map(e => e.trim()).filter(e => e);

            // LOGIC SPLIT: Vendor vs Site
            if (mode === 'vendor') {
                const deptSelect = document.getElementById('email-vendor-dept');
                const selectedEmail = deptSelect.value;
                
                // If a specific dept was selected in the dropdown, use it.
                // Otherwise fall back to trying to find a default in the directory if the dropdown wasn't shown
                if (selectedEmail) {
                    to = selectedEmail;
                } else {
                    // Fallback for cases where maybe ticket vendor isn't in directory
                    to = ''; 
                    alert(`Vendor '${ticket.vendor}' email not found. Please add to Directory.`);
                }
                
                // Add Site & DM to CC for vendor emails
                if (siteInfo.storeEmail) ccList.unshift(siteInfo.storeEmail);
                if (siteInfo.dmEmail) ccList.unshift(siteInfo.dmEmail);

            } else {
                // Normal Site Email
                to = siteInfo.storeEmail;
                // Add DM if template requests it
                if (tpl.ccDM !== false && siteInfo.dmEmail) {
                    ccList.unshift(siteInfo.dmEmail);
                }
            }

            const cc = [...new Set(ccList)].join(','); // Dedup emails

            // Calculate Lifespan
            const start = new Date(ticket.date);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const lifespan = isNaN(diffTime) ? '0' : Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Replacement
            const subject = encodeURIComponent(tpl.subject
                .replace(/{ticket}/g, ticket.id)
                .replace(/{site}/g, ticket.site)
                .replace(/{issue}/g, ticket.issue || 'Issue')
                .replace(/{created}/g, ticket.date)
                .replace(/{lifespan}/g, lifespan));
                
            const body = encodeURIComponent(tpl.body
                .replace(/{ticket}/g, ticket.id)
                .replace(/{site}/g, ticket.site)
                .replace(/{issue}/g, ticket.issue || 'Issue')
                .replace(/{created}/g, ticket.date)
                .replace(/{lifespan}/g, lifespan));

            const mailto = `mailto:${to}?cc=${cc}&subject=${subject}&body=${body}`;
            window.location.href = mailto;
            
            closeEmailModal();
        };

        window.incrementVendorCount = async (id) => {
            if (!user) return;
            const t = importedTickets.find(x => x.id === id);
            const newCount = (t.vendorEmailCount || 0) + 1;
            const safeId = id.replace(/[\/\.\#\$\s]/g, '-');
            await setDoc(doc(ticketsRef, safeId), { ...t, vendorEmailCount: newCount }, { merge: true });
        };

        // --- Log Logic ---
        window.handleActivityTypeChange = () => {
            const select = document.getElementById('ticket-type');
            const customContainer = document.getElementById('custom-activity-container');
            if (select.value === 'Other') {
                customContainer.classList.remove('hidden');
            } else {
                customContainer.classList.add('hidden');
            }
            toggleSiteRequirement();
        };

        window.logWork = async () => {
            if (!user) return;
            const idInput = document.getElementById('editing-id').value;
            const site = document.getElementById('site-id').value;
            const ticketNum = document.getElementById('ticket-number').value;
            const typeSelect = document.getElementById('ticket-type');
            let type = typeSelect.value;
            
            if (type === 'Other') {
                type = document.getElementById('custom-activity-type').value || 'Other';
            }
            
            const desc = document.getElementById('work-desc').value;
            const closed = document.getElementById('ticket-closed').checked;

            if (!desc) return showToast("Description is required");

            const todayStr = new Date().toISOString().split('T')[0];

            const logData = {
                id: idInput ? parseInt(idInput) : Date.now(),
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                date: todayStr, 
                site: site || "N/A",
                ticketNum,
                type,
                desc,
                closed
            };

            await setDoc(doc(logsRef, logData.id.toString()), logData);
            showToast("Synced to Cloud");
            resetForm();
        };

        window.deleteLog = async (id) => {
            if (!user || !confirm("Delete this log?")) return;
            await deleteDoc(doc(logsRef, id.toString()));
        };

        window.clearLogs = async () => {
            const viewDate = document.getElementById('log-view-date').value;
            if (!user || !confirm(`Clear all logs for ${viewDate}? This clears it for everyone!`)) return;
            
            const logsToDelete = workLogs.filter(l => (l.date || '').includes(viewDate));
            const batch = writeBatch(db);
            logsToDelete.forEach(l => {
                batch.delete(doc(logsRef, l.id.toString()));
            });
            await batch.commit();
            showToast(`Logs cleared.`);
        };

        // --- Manager Logic ---
        function parseCSVLine(line) {
            const result = [];
            let current = "";
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ""; }
                else current += char;
            }
            result.push(current.trim());
            return result.map(val => val.replace(/^"|"$/g, ''));
        }

        window.importTickets = async (event) => {
            if (!user) return;
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split(/\r?\n/).slice(1); 
                const batchSize = 500;
                let processedCount = 0;

                const allRows = rows.filter(r => r.trim());
                if (allRows.length === 0) return showToast("CSV file appears to be empty.");

                for (let i = 0; i < allRows.length; i += batchSize) {
                    const batch = writeBatch(db);
                    const chunk = allRows.slice(i, i + batchSize);

                    chunk.forEach(row => {
                        const cols = parseCSVLine(row);
                        const isFullExport = cols.length >= 9;
                        const rawId = cols[0] || 'T' + Date.now() + Math.random().toString(36).substr(2, 5);
                        const safeId = rawId.replace(/[\/\.\#\$\s]/g, '-');
                        
                        const tData = {
                            id: rawId,
                            site: cols[1] || 'Internal',
                            issue: cols[2] || 'IT Request',
                            date: cols[3] || new Date().toISOString().split('T')[0],
                            vendor: cols[4] || 'N/A',
                            notes: isFullExport ? (cols[5] || '') : '',
                            status: isFullExport ? (cols[6] || 'pending') : 'pending',
                            attempts: isFullExport ? parseInt(cols[7] || 0) : 0,
                            siteResponded: isFullExport ? (cols[8] === 'true') : false,
                            turn: isFullExport ? (cols[9] || 'Other') : 'Other',
                            closedAt: isFullExport ? (cols[10] || null) : null,
                            vendorEmailCount: isFullExport ? parseInt(cols[11] || 0) : 0
                        };
                        batch.set(doc(ticketsRef, safeId), tData);
                    });

                    try {
                        await batch.commit();
                        processedCount += chunk.length;
                    } catch (err) {
                        console.error("Batch error:", err);
                        showToast("Error processing batch. Check rules/network.");
                        return;
                    }
                }
                showToast(`Sync Complete: ${processedCount} tickets.`);
            };
            reader.readAsText(file);
        };

        window.toggleTicketStatus = async (id) => {
            if (!user) return;
            const t = importedTickets.find(x => x.id === id);
            const isClosing = t.status !== 'closed';
            const newStatus = isClosing ? 'closed' : 'pending';
            const safeId = id.replace(/[\/\.\#\$\s]/g, '-');
            
            const updateData = { 
                ...t, 
                status: newStatus,
                closedAt: isClosing ? new Date().toISOString() : null 
            };
            
            await setDoc(doc(ticketsRef, safeId), updateData, { merge: true });
            syncTicketToLog(updateData, isClosing ? "Marked Closed" : "Re-opened");
        };

        window.changeAttempt = async (id, delta) => {
            if (!user) return;
            const t = importedTickets.find(x => x.id === id);
            const newAttempts = Math.max(0, t.attempts + delta);
            const safeId = id.replace(/[\/\.\#\$\s]/g, '-');
            await setDoc(doc(ticketsRef, safeId), { ...t, attempts: newAttempts }, { merge: true });
            syncTicketToLog({ ...t, attempts: newAttempts }, "Attempt Tracker");
        };

        window.saveNote = async () => {
            if (!user) return;
            const id = document.getElementById('note-ticket-id').value;
            const t = importedTickets.find(x => x.id === id);
            if (!t) return;

            const updated = {
                ...t,
                notes: document.getElementById('note-text').value,
                turn: document.getElementById('note-turn').value,
                vendor: document.getElementById('note-vendor').value,
                siteResponded: document.getElementById('note-responded').value === 'true'
            };
            const safeId = id.replace(/[\/\.\#\$\s]/g, '-');
            await setDoc(doc(ticketsRef, safeId), updated);
            syncTicketToLog(updated, "Status Updated");
            closeNotes();
        }

        const syncTicketToLog = async (ticket, actionName) => {
            if (!user) return;
            const todayStr = new Date().toISOString().split('T')[0];
            const existing = workLogs.find(l => l.ticketNum === ticket.id && l.date === todayStr);
            const vendorInfo = ticket.vendor && ticket.vendor !== 'N/A' ? ` [Vendor: ${ticket.vendor}]` : '';
            const desc = `[Sync] ${actionName}${vendorInfo}: Attempts: ${ticket.attempts}. Turn: ${ticket.turn}. Notes: ${ticket.notes || ticket.issue}`;
            
            const logData = {
                id: existing ? existing.id : Date.now(),
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                date: todayStr,
                site: ticket.site,
                ticketNum: ticket.id,
                type: "Aloha POS",
                desc,
                closed: (ticket.status === 'closed')
            };
            await setDoc(doc(logsRef, logData.id.toString()), logData);
        };

        window.clearImportedTickets = async () => {
            if (!user || !confirm("Delete all tickets?")) return;
            const snapshot = await getDocs(ticketsRef);
            const batch = writeBatch(db);
            snapshot.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        // --- UI Rendering ---
        window.renderLogs = () => {
            const list = document.getElementById('activity-list');
            const pendingList = document.getElementById('global-pending-list');
            const viewDate = document.getElementById('log-view-date').value;
            
            const globalPending = workLogs.filter(l => !l.closed);
            document.getElementById('pending-count-badge').innerText = globalPending.length;

            if (globalPending.length === 0) {
                pendingList.innerHTML = `<p class="text-[10px] text-gray-400 italic text-center py-2">No items in unresolved queue.</p>`;
            } else {
                pendingList.innerHTML = globalPending.map(log => `
                    <div class="flex items-center justify-between p-2 border rounded-md bg-white border-yellow-200">
                        <div class="flex-1 min-w-0 pr-4">
                            <p class="text-xs font-bold text-gray-700 truncate">${log.site} <span class="text-[10px] font-normal text-gray-400">(${log.date})</span></p>
                            <p class="text-[10px] text-gray-500 truncate">${log.desc.replace(/^\[Sync\].*?: /i, '')}</p>
                        </div>
                        <button onclick="editLog(${log.id})" class="text-[10px] text-blue-600 hover:underline font-bold">Resolve</button>
                    </div>
                `).join('');
            }

            const filteredLogs = workLogs.filter(l => (l.date || '').includes(viewDate));

            if (filteredLogs.length === 0) return list.innerHTML = `<p class="text-gray-400 italic text-center py-4">No activity logged for ${viewDate}.</p>`;
            
            list.innerHTML = filteredLogs.map(log => `
                <div class="flex items-start gap-4 p-4 border rounded-lg bg-white group hover:border-wendys-blue transition ${!log.closed ? 'pulse-pending border-yellow-200' : ''}">
                    <div class="w-2 h-2 mt-2 rounded-full ${log.closed ? 'bg-green-500' : 'bg-yellow-500'}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <span class="font-bold text-sm text-gray-800">${log.site} ${log.ticketNum ? `<span class="text-wendys-blue">#${log.ticketNum}</span>` : ''}</span>
                            <span class="text-[10px] uppercase font-bold text-gray-400">${log.time}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${log.desc}</p>
                        ${!log.closed ? '<p class="text-[10px] text-yellow-600 font-bold uppercase mt-1">Pending Task</p>' : ''}
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100">
                        <button onclick="editLog(${log.id})" class="text-xs text-blue-500 hover:underline">Edit</button>
                        <button onclick="deleteLog(${log.id})" class="text-xs text-red-400 hover:underline">Del</button>
                    </div>
                </div>
            `).join('');
        };

        window.renderImportedTickets = () => {
            const list = document.getElementById('imported-ticket-list');

            const allTickets = importedTickets;
            const openTickets = allTickets.filter(t => (t.status || '').toLowerCase() !== 'closed');
            const closedTickets = allTickets.filter(t => (t.status || '').toLowerCase() === 'closed');
            
            document.getElementById('stat-total-open').innerText = openTickets.length;
            document.getElementById('stat-total-closed').innerText = closedTickets.length;
            document.getElementById('stat-total-all').innerText = openTickets.length;
            
            const closureRate = allTickets.length ? ((closedTickets.length / allTickets.length) * 100).toFixed(1) : 0;
            document.getElementById('stat-closure-percent').innerText = `${closureRate}%`;

            const closedWithTime = closedTickets.filter(t => t.closedAt && t.date);
            if (closedWithTime.length > 0) {
                const totalDiff = closedWithTime.reduce((acc, t) => {
                    const start = new Date(t.date);
                    const end = new Date(t.closedAt);
                    const diff = end - start;
                    return (isNaN(start.getTime()) || isNaN(end.getTime()) || diff < 0) ? acc : acc + diff;
                }, 0);
                
                const avgMs = totalDiff / closedWithTime.length;
                const avgHours = avgMs / (1000 * 60 * 60);
                
                if (avgHours < 24) {
                    document.getElementById('stat-avg-time').innerText = `${avgHours.toFixed(1)} Hours`;
                } else {
                    document.getElementById('stat-avg-time').innerText = `${(avgHours / 24).toFixed(1)} Days`;
                }
            } else {
                document.getElementById('stat-avg-time').innerText = 'N/A';
            }
            
            const waitTechCount = openTickets.filter(t => (t.turn || '').toLowerCase().includes('tech')).length;
            const waitSiteCount = openTickets.filter(t => (t.turn || '').toLowerCase().includes('site')).length;
            const waitOtherCount = openTickets.length - (waitTechCount + waitSiteCount);

            document.getElementById('stat-tech-turn').innerText = waitTechCount;
            document.getElementById('stat-site-turn').innerText = waitSiteCount;
            document.getElementById('stat-other-turn').innerText = Math.max(0, waitOtherCount);

            if (importedTickets.length === 0) return list.innerHTML = `<div class="text-center py-10 text-gray-400"><p>No shared tickets found.</p></div>`;

            const queryText = document.getElementById('ticket-search').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const sortOrder = document.getElementById('sort-order').value;

            let filtered = importedTickets.filter(t => {
                const matchesSearch = t.id.toLowerCase().includes(queryText) || t.site.toLowerCase().includes(queryText) || t.issue.toLowerCase().includes(queryText);
                const matchesStatus = statusFilter === 'all' || t.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
            });

            list.innerHTML = filtered.map(t => `
                <div class="border rounded-lg p-4 bg-white transition hover:shadow-sm ${t.status === 'closed' ? 'opacity-60 bg-gray-50' : ''}">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${t.status === 'closed' ? 'status-badge-closed' : 'status-badge-pending'}">${(t.status || 'PENDING').toUpperCase()}</span>
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${getTurnClass(t.turn)}">TURN: ${(t.turn || 'OTHER').toUpperCase()}</span>
                                ${t.siteResponded ? '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-green-100 text-green-800">SITE RESPONDED</span>' : ''}
                                ${t.vendorEmailCount > 0 ? `<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 border border-purple-200">Vendor Emailed: ${t.vendorEmailCount} times</span>` : ''}
                                <span class="text-[10px] font-mono text-gray-400">${t.date}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 flex items-center gap-2">
                                ${t.site} <span class="text-wendys-blue font-mono text-sm">#${t.id}</span>
                                ${t.vendor && t.vendor !== 'N/A' ? `<span class="ml-2 text-[10px] text-purple-600 bg-purple-50 px-2 py-0.5 rounded border border-purple-100">Vendor: ${t.vendor}</span>` : ''}
                            </h4>
                            <p class="text-sm text-gray-600 mb-2">${t.issue}</p>
                            ${t.notes ? `<div class="text-[11px] bg-gray-50 p-2 border-l-2 border-wendys-blue text-gray-700 italic"><b>Last Note:</b> ${t.notes}</div>` : ''}
                        </div>
                        <div class="flex flex-col gap-3 w-full md:w-48">
                            <div class="flex items-center justify-between bg-gray-100 rounded-lg p-1">
                                <span class="text-[10px] font-bold px-2 text-gray-500 uppercase">Attempts: ${t.attempts || 0}</span>
                                <div class="flex gap-1">
                                    <button onclick="changeAttempt('${t.id}', -1)" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-50">-</button>
                                    <button onclick="changeAttempt('${t.id}', 1)" class="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-50">+</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="openNotes('${t.id}')" class="px-2 py-1.5 text-[11px] font-bold border rounded bg-white hover:bg-gray-50">Update</button>
                                <button onclick="openEmailModal('${t.id}', 'site')" class="px-2 py-1.5 text-[11px] font-bold bg-wendys-blue text-white rounded">Email Site</button>
                                <button onclick="openEmailModal('${t.id}', 'vendor')" class="px-2 py-1.5 text-[11px] font-bold bg-purple-600 text-white rounded col-span-2">Email Vendor</button>
                            </div>
                            <button onclick="toggleTicketStatus('${t.id}')" class="w-full py-1.5 text-[11px] font-bold rounded ${t.status === 'closed' ? 'bg-gray-300' : 'bg-green-600 text-white'}">
                                ${t.status === 'closed' ? 'Re-open Ticket' : 'Mark Resolved'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        function getTurnClass(turn) {
            if (!turn) return 'turn-other';
            const t = turn.toLowerCase();
            if (t.includes('tech')) return 'turn-tech';
            if (t.includes('site')) return 'turn-site';
            if (t.includes('dm')) return 'turn-mgmt';
            if (t.includes('ncr') || t.includes('viking') || t.includes('mood') || t.includes('jolt') || t.includes('accenture')) return 'turn-vendor';
            return 'turn-other';
        }

        // --- Shared Helpers ---
        window.exportTicketsCSV = () => {
            if (importedTickets.length === 0) return showToast("Nothing to export");
            let csv = "Ticket#,Site,Issue,Date,Vendor,Notes,Status,Attempts,SiteResponded,WhoseTurn,ClosedAt,VendorEmailCount\n";
            importedTickets.forEach(t => {
                csv += `"${t.id}","${t.site}","${(t.issue || '').replace(/"/g, '""')}","${t.date}","${(t.vendor || 'N/A').replace(/"/g, '""')}","${(t.notes || '').replace(/"/g, '""')}","${t.status}","${t.attempts}","${t.siteResponded}","${t.turn}","${t.closedAt || ''}","${t.vendorEmailCount || 0}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `it_cloud_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        window.switchTab = (tab) => {
            document.getElementById('content-log').classList.toggle('hidden', tab !== 'log');
            document.getElementById('content-manager').classList.toggle('hidden', tab !== 'manager');
            document.getElementById('content-settings').classList.toggle('hidden', tab !== 'settings');
            
            document.getElementById('tab-log').classList.toggle('active', tab === 'log');
            document.getElementById('tab-manager').classList.toggle('active', tab === 'manager');
            document.getElementById('tab-settings').classList.toggle('active', tab === 'settings');
        };

        window.toggleSiteRequirement = () => {
            const select = document.getElementById('ticket-type');
            const group = select.options[select.selectedIndex].parentElement.id;
            document.getElementById('site-req-star').classList.toggle('hidden', group === 'group-admin');
        };

        window.openNotes = (id) => {
            const t = importedTickets.find(x => x.id === id);
            if (!t) return;
            document.getElementById('note-ticket-id').value = id;
            document.getElementById('note-text').value = t.notes || '';
            document.getElementById('note-turn').value = t.turn || 'Other';
            document.getElementById('note-vendor').value = t.vendor || 'N/A';
            document.getElementById('note-responded').value = t.siteResponded.toString();
            document.getElementById('notes-modal').classList.remove('hidden');
        };

        window.closeNotes = () => document.getElementById('notes-modal').classList.add('hidden');
        window.filterImportedTickets = () => renderImportedTickets();
        
        window.editLog = (id) => {
            const log = workLogs.find(l => l.id == id);
            if (!log) return;
            document.getElementById('editing-id').value = log.id;
            document.getElementById('site-id').value = log.site === "N/A" ? "" : log.site;
            document.getElementById('ticket-number').value = log.ticketNum || '';
            
            const select = document.getElementById('ticket-type');
            let found = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === log.type) { found = true; break; }
            }

            if (found) {
                select.value = log.type;
                document.getElementById('custom-activity-container').classList.add('hidden');
            } else {
                select.value = 'Other';
                document.getElementById('custom-activity-container').classList.remove('hidden');
                document.getElementById('custom-activity-type').value = log.type;
            }

            document.getElementById('work-desc').value = log.desc;
            document.getElementById('ticket-closed').checked = log.closed;
            document.getElementById('submit-btn').innerText = "Update Entry";
            document.getElementById('cancel-edit').classList.remove('hidden');
            switchTab('log');
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.resetForm = () => {
            document.getElementById('editing-id').value = "";
            document.getElementById('site-id').value = "";
            document.getElementById('ticket-number').value = "";
            document.getElementById('ticket-type').value = "Aloha POS";
            document.getElementById('custom-activity-container').classList.add('hidden');
            document.getElementById('custom-activity-type').value = "";
            document.getElementById('work-desc').value = "";
            document.getElementById('ticket-closed').checked = false;
            document.getElementById('submit-btn').innerText = "Add to Daily Log";
            document.getElementById('cancel-edit').classList.add('hidden');
        };

        window.copyTemplate = (type) => {
            let t = "";
            if (type === 'welcome') t = "Team,\n\nI've received your request. I'm checking the logs for your site and will call shortly.\n\nThanks,\nWendy's IT Technician";
            if (type === 'followup') t = "Team,\n\nI attempted to call the site to troubleshoot the earlier request but was unable to reach anyone. Please let me know a good time to call back.\n\nThanks,\nWendy's IT Technician";
            if (type === 'closed') t = "Team,\n\nThis request has been resolved. Please test the register and let me know if you need anything else.\n\nThanks,\nWendy's IT Technician";
            copyToClipboard(t, "Template copied!");
        };

        window.generateRecap = () => {
            const viewDate = document.getElementById('log-view-date').value;
            const filteredLogs = workLogs.filter(l => (l.date || '').includes(viewDate));

            if (filteredLogs.length === 0) return showToast(`No logs to recap for ${viewDate}!`);
            
            const closed = filteredLogs.filter(l => l.closed);
            const pending = filteredLogs.filter(l => !l.closed);

            const cleanDesc = (desc) => {
                if (desc.includes("Notes: ")) {
                    return desc.split("Notes: ").slice(1).join("Notes: ");
                }
                return desc.replace(/^\[Sync\].*?: /i, '');
            };

            let txt = `DAILY IT ACTIVITY SUMMARY - ${viewDate}\n`;
            txt += "=".repeat(40) + "\n";
            txt += `Handled: ${filteredLogs.length} items | Closed: ${closed.length}\n\n`;
            
            if (closed.length) {
                txt += "RESOLVED:\n" + closed.map(l => `‚Ä¢ ${l.site}${l.ticketNum ? ' [#'+l.ticketNum+']' : ''}: ${cleanDesc(l.desc)}`).join('\n');
            }
            
            if (pending.length) {
                txt += "\n\nPENDING/FOLLOW-UP:\n" + pending.map(l => `‚Ä¢ ${l.site}${l.ticketNum ? ' [#'+l.ticketNum+']' : ''}: ${cleanDesc(l.desc)}`).join('\n');
            }
            
            txt += "\n\nThanks,\nWendy's IT Technician";
            document.getElementById('recap-content').innerText = txt;
            document.getElementById('recap-modal').classList.remove('hidden');
        };

        window.closeRecap = () => document.getElementById('recap-modal').classList.add('hidden');
        window.copyRecapToClipboard = () => copyToClipboard(document.getElementById('recap-content').innerText, "Recap copied!");

        function copyToClipboard(text, toastMsg) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast(toastMsg);
        }

        function showToast(m) { 
            const t = document.getElementById('toast'); 
            if (!t) return;
            t.innerText = m; 
            t.classList.remove('translate-y-20'); 
            setTimeout(() => t.classList.add('translate-y-20'), 3000); 
        }

        initAuth();
    </script>
</body>
</html>
